# -*- org-confirm-babel-evaluate: nil -*-
* Notes on the go
excellent source of knowledge https://github.com/dharrigan/nextjdbc-integrant

** API

*** URI schema
/books
/books/{id}
/books/{id}/author -- ?
/books/{id}/comments

/authors
/authors/{id}
/authors/{id}/comments  -- ? do we need one ?

*** API Investigation
    :PROPERTIES:
    :header-args: :var API="http://localhost:5757/v1"
    :END:


**** books/
 
***** ctx obj dump
#+begin_src clojure
{:response
 {:headers {},
  :last-modified "Thu, 21 Nov 2019 10:51:46 GMT",
  :vary #{:media-type},
  :produces
  {:media-type
   {:name "text/plain",
    :type "text",
    :subtype "plain",
    :parameters {},
    :quality 0.9}}},
 :properties {:last-modified #inst "2019-11-21T10:51:46.108-00:00"},
 :request
 {:aleph/request-arrived 501626754028580,
  :aleph/keep-alive? true,
  :remote-addr "0:0:0:0:0:0:0:1",
  :params {:id "2"},
  :route-params {:id "2"},
  :headers
  {"sec-fetch-site" "none",
   "host" "localhost:5757",
   "user-agent"
   "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_1) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/78.0.3904.97 Safari/537.36",
   "cookie"
   "ring-session=4fff676a-286b-44e0-a6fb-3bfb7895f513; secret=e7fd2da7-73fc-4470-bc54-afe6552ba817; PGADMIN_LANGUAGE=en",
   "sec-fetch-user" "?1",
   "connection" "keep-alive",
   "upgrade-insecure-requests" "1",
   "pragma" "no-cache",
   "accept"
   "text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,image/apng,*/*;q=0.8,application/signed-exchange;v=b3",
   "accept-language" "en-US,en;q=0.9,ru-UA;q=0.8,ru;q=0.7",
   "accept-encoding" "gzip, deflate, br",
   "sec-fetch-mode" "navigate",
   "cache-control" "no-cache"},
  :server-port 5757,
  :uri "/v1/books/2",
  :server-name "localhost",
  :query-string nil,
  :body
  << stream: {:pending-puts 0, :drained? false, :buffer-size 0, :permanent? false, :type "netty", :sink? true, :closed? true, :pending-takes 0, :buffer-capacity 16384, :connection {:local-address "localhost/0:0:0:0:0:0:0:1:5757", :remote-address "/0:0:0:0:0:0:0:1:65400", :writable? true, :readable? true, :closed? false, :direction :inbound}, :source? true} >>,
  :scheme :http,
  :request-method :get},
 :request-id #uuid "5f265c3a-1ded-49a4-8c02-31dc8060b09a",
 :method :get,
 :authorization true,
 :cookies
 {"ring-session" "4fff676a-286b-44e0-a6fb-3bfb7895f513",
  "secret" "e7fd2da7-73fc-4470-bc54-afe6552ba817",
  "PGADMIN_LANGUAGE" "en"},
 :known-methods
 {:*
  #object[yada.methods.AnyMethod 0x51876e58 "yada.methods.AnyMethod@51876e58"],
  :head
  #object[yada.methods.HeadMethod 0x6e5e4e29 "yada.methods.HeadMethod@6e5e4e29"],
  :get
  #object[yada.methods.GetMethod 0x6512bc2b "yada.methods.GetMethod@6512bc2b"],
  :put
  #object[yada.methods.PutMethod 0x81501a5 "yada.methods.PutMethod@81501a5"],
  :post
  #object[yada.methods.PostMethod 0x217afd82 "yada.methods.PostMethod@217afd82"],
  :delete
  #object[yada.methods.DeleteMethod 0x4c4f5309 "yada.methods.DeleteMethod@4c4f5309"],
  :options
  #object[yada.methods.OptionsMethod 0x2108791b "yada.methods.OptionsMethod@2108791b"],
  :trace
  #object[yada.methods.TraceMethod 0x10b22907 "yada.methods.TraceMethod@10b22907"]},
 :produces
 ({:media-type
   {:name "application/edn",
    :type "application",
    :subtype "edn",
    :parameters {},
    :quality 0.7}}
  {:media-type
   {:name "application/json",
    :type "application",
    :subtype "json",
    :parameters {},
    :quality 0.8}}
  {:media-type
   {:name "text/plain",
    :type "text",
    :subtype "plain",
    :parameters {},
    :quality 0.9}}),
 :interceptor-chain
 [#function[yada.interceptors/available?]
  #function[yada.interceptors/known-method?]
  #function[yada.interceptors/uri-too-long?]
  #function[yada.interceptors/TRACE]
  #function[yada.interceptors/method-allowed?]
  #function[yada.swagger-parameters/parse-parameters]
  #function[yada.interceptors/capture-proxy-headers]
  #function[yada.cookies/consume-cookies]
  #function[yada.security/authenticate]
  #function[yada.interceptors/get-properties]
  #function[yada.security/authorize]
  #function[yada.interceptors/process-content-encoding]
  #function[yada.interceptors/process-request-body]
  #function[yada.interceptors/check-modification-time]
  #function[yada.interceptors/select-representation]
  #function[yada.interceptors/if-match]
  #function[yada.interceptors/if-none-match]
  #function[yada.interceptors/invoke-method]
  #function[yada.interceptors/get-new-properties]
  #function[yada.interceptors/compute-etag]
  #function[yada.security/access-control-headers]
  #function[yada.security/security-headers]
  #function[yada.interceptors/create-response]
  #function[yada.interceptors/logging]
  #function[yada.interceptors/return]],
 :uri-info #function[bidi.vhosts/find-handler/fn--24608/fn--24616],
 :allowed-methods #{:get :head :options},
 :route-params {:id "2"},
 :method-wrapper
 #object[yada.methods.GetMethod 0x6512bc2b "yada.methods.GetMethod@6512bc2b"],
 :yada.context/cache #<Atom@63302a44: {}>,
 :id :wiz.blog.api.core/books,
 :resource
 {:produces
  [{:media-type
    {:name "application/edn",
     :type "application",
     :subtype "edn",
     :parameters {},
     :quality 0.7}}
   {:media-type
    {:name "application/json",
     :type "application",
     :subtype "json",
     :parameters {},
     :quality 0.8}}
   {:media-type
    {:name "text/plain",
     :type "text",
     :subtype "plain",
     :parameters {},
     :quality 0.9}}],
  :properties {:last-modified #inst "2019-11-21T10:51:46.108-00:00"},
  :id :wiz.blog.api.core/books,
  :description "Full book info",
  :methods
  {:get {:response #function[wiz.blog.api.core/books/fn--62859]}},
  :show-stack-traces? true},
 :error-interceptor-chain
 [#function[yada.security/access-control-headers]
  #function[yada.interceptors/create-response]
  #function[yada.interceptors/logging]
  #function[yada.interceptors/return]],
 :parameters {:path {:id "2"}}}
#+end_src      
***** get all books   
  #+NAME: get-books
  #+BEGIN_SRC shell :var uri="${API}" :results verbatim :cache no
  curl -sv "$API/books"
  #+END_SRC

  #+RESULTS: get-books
  : ({:id 1, :title "Db Book of all Books"}
  :  {:id 2, :title "Psyho Self control"}
  :  {:id 3, :title "RDBMS coockbook"}
  :  {:id 4, :title "Event logigns in s UI systems"}
  :  {:id 5, :title "Awareness"})

***** get whole book
  #+NAME: get-book 
  #+begin_src sh :results verbatim
    # exec 2>&1
    curl -vs "${API}/books/1" \
         -H 'Accept: text/plain, application/edn;q=0.9'
  #+end_src

  #+RESULTS: get-book
  : {:id 1,
  :  :title "Db Book of all Books",
  :  :author_id 1,
  :  :created_at #inst "2019-11-19T19:47:06.767703000-00:00"}

***** single book not found
  #+NAME: not-found 
  #+begin_src sh :results verbatim
    # exec 2>&1
    curl -vsi "${API}/books/0" \
         -H 'Accept: text/plain, application/edn;q=0.9'
  #+end_src

  #+RESULTS: not-found
  #+begin_example
  HTTP/1.1 404 Not Found
  X-Frame-Options: SAMEORIGIN
  X-XSS-Protection: 1; mode=block
  X-Content-Type-Options: nosniff
  Content-Length: 24
  Content-Type: text/plain
  Last-Modified: Thu, 21 Nov 2019 10:32:07 GMT
  Vary: accept
  Server: Aleph/0.4.4
  Connection: Keep-Alive
  Date: Thu, 21 Nov 2019 10:38:20 GMT
 
  {:message "Not found"}

  #+end_example

**** authors/
***** get all authors
  #+NAME: get-authors
  #+BEGIN_SRC shell :var uri="${API}" :results verbatim :cache no
  curl -sv "$API/authors"
  #+END_SRC

  #+RESULTS: get-authors
  : ({:id 1, :name "Vlad", :nickname "vladkotu", :email "vald@kot.com"}
  :  {:id 2, :name "Ivan", :nickname "ivanko", :email "ivan@ttt.com"}
  :  {:id 3, :name "Svetlana", :nickname "svenlo", :email "svet@ttt.com"})

***** get whole author
  #+NAME: get-author
  #+BEGIN_SRC shell :results verbatim
  curl -sv "$API/authors/2"
  #+END_SRC

  #+RESULTS: get-author
  : {:id 2,
  :  :name "Ivan",
  :  :email "ivan@ttt.com",
  :  :nickname "ivanko",
  :  :biography nil,
  :  :created_at #inst "2019-11-19T12:22:11.680514000-00:00"}

***** single author not found
  #+NAME: author-not-found
  #+BEGIN_SRC shell :results verbatim
  curl -svi "$API/authors/0" \
       -H   "Accept: application/json"
  #+END_SRC

  #+RESULTS: author-not-found
  #+begin_example
  HTTP/1.1 404 Not Found
  X-Frame-Options: SAMEORIGIN
  X-XSS-Protection: 1; mode=block
  X-Content-Type-Options: nosniff
  Content-Length: 24
  Content-Type: application/json
  Last-Modified: Thu, 21 Nov 2019 11:10:47 GMT
  Vary: accept
  Server: Aleph/0.4.4
  Connection: Keep-Alive
  Date: Thu, 21 Nov 2019 11:16:04 GMT
  
  {"message":"Not found"}
  #+end_example

** ENV
   couldn't find a way to reuse environment variables in app config and
   docker-compose mostly becsause clojure when running do not respect local env
   variables setting local variables do not work neither by sourcing key val
   pairs from .env file nor by using dotenv plugin for emacs (had hope cider
   would catch them up)
   sh -ac 'source .env && clojure -A:dev' - do not work as well
   only thing is working - DB_USER=user clojure -A:dev - which obviously would
   not work as at least 10 variables should be passed
     - [!] pass host secrets to docker image and app form env
   
   Currently to configure things in a dev mode (mac os involved) 
   We have to save copy of env vars in a .env file (it still works for docker-compose)
   and inside aero confg (secrets.edn)
   
** DB
*** up and running [100%]
     - [X] create docker-compose file
      [[file:wiz.blog.api/docker-compose.yml::version:%20"3"][docker-compose.yml]] 
     - [X] run container
       #+begin_src 
         docker-compose up -d
       #+end_src
     - [X] test connection from terminal
       #+begin_src 
 psql -h localhost -p 54320 -U vladkotu -d blog_db
       #+end_src
     - [X] connect form app
     - [X] create scheme
     - [X] apply scheme
**** [%] migrations
     - [ ] what migration libs are exists?

*** check your data with pgadmin [0%]
    - [ ] add dpage/pgadmin to docker compose
    - [ ] connect to app db
    - [ ] restrict pgadmin to start only in dev mode
    
** Quiz
*** How to write to STDOUT but not only to logs?
    seems like simple println works
*** how to read config values inside application?
